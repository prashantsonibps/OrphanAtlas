<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results for "{{ query }}"</title>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        function fetchSheetData(sheetName, query, sheetId) {
            const allPopups = document.querySelectorAll('.popup-content');
            allPopups.forEach(popup => popup.classList.remove('active'));
            const content = document.getElementById(sheetId);
            content.classList.add('active');

            if (!content.dataset.loaded) {
                if (sheetName === "Geographic Spread") {
                    content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><div id='map' style='height: 250px; width: 100%;'></div><p>Loading geographic data...</p>";
                    fetch("/get_geographic_spread", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ query: query })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error || !data.locations || data.locations.length === 0) {
                            content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>No geographic data available.</p>";
                        } else {
                            const map = L.map('map').setView([20, 0], 2);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(map);

                            // Country coordinates (simplified, approximate centroids)
                            const countryCoords = {
                                "United States": [37.0902, -95.7129],
                                "China": [35.8617, 104.1954],
                                "India": [20.5937, 78.9629],
                                "Brazil": [-14.2350, -51.9253],
                                "Russia": [61.5240, 105.3188],
                                "Japan": [36.2048, 138.2529],
                                "Germany": [51.1657, 10.4515],
                                "United Kingdom": [55.3781, -3.4360],
                                "France": [46.2276, 2.2137],
                                "Italy": [41.8719, 12.5674],
                                "Canada": [56.1304, -106.3468],
                                "Australia": [-25.2744, 133.7751],
                                "South Africa": [-30.5595, 22.9375],
                                "Nigeria": [9.0820, 8.6753],
                                "Mexico": [23.6345, -102.5528],
                                "Spain": [40.4637, -3.7492],
                                "Indonesia": [-0.7893, 113.9213],
                                "Pakistan": [30.3753, 69.3451],
                                "Bangladesh": [23.6850, 90.3563],
                                "Egypt": [26.8206, 30.8025]
                                // Add more countries as needed
                            };

                            data.locations.forEach(country => {
                                if (countryCoords[country]) {
                                    L.circleMarker(countryCoords[country], {
                                        radius: 8,
                                        color: 'red',
                                        fillColor: '#ff0000',
                                        fillOpacity: 0.8
                                    }).addTo(map).bindPopup(country);
                                }
                            });

                            content.innerHTML = `<span class='close-btn' onclick='closePopup(this)'>×</span>
                                                <div id='map' style='height: 250px; width: 100%;'></div>
                                                <p><strong>Countries with high prevalence:</strong> ${data.locations.join(", ")}</p>
                                                <hr><p><strong>Note:</strong> This data is generated by Deepseek V3 AI model</p>`;
                            const newMap = L.map('map').setView([20, 0], 2);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(newMap);
                            data.locations.forEach(country => {
                                if (countryCoords[country]) {
                                    L.circleMarker(countryCoords[country], {
                                        radius: 8,
                                        color: 'red',
                                        fillColor: '#ff0000',
                                        fillOpacity: 0.8
                                    }).addTo(newMap).bindPopup(country);
                                }
                            });
                        }
                        content.dataset.loaded = "true";
                    })
                    .catch(error => {
                        console.error("Geographic spread fetch error:", error);
                        content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>Error fetching geographic data. Please try again.</p>";
                        content.dataset.loaded = "true";
                    });
                } else {
                    const url = (sheetName === "AI Generated Data") ? "/fetch_data_stream" : "/fetch_data";
                    const isStream = sheetName === "AI Generated Data";

                    if (isStream) {
                        content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>Generating data using Deepseek...</p>";
                        fetch(url, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ sheet_name: sheetName, query: query })
                        }).then(response => {
                            const reader = response.body.getReader();
                            const decoder = new TextDecoder();
                            let accumulatedText = "";
                            let lines = [];
                            function readStream() {
                                reader.read().then(({ done, value }) => {
                                    if (done) {
                                        const cleanedLines = lines.map(line => line.replace(/^\d+\.\s*/, ""));
                                        content.innerHTML = `<span class='close-btn' onclick='closePopup(this)'>×</span><p>${cleanedLines.join("<br>")}</p><hr><p><strong>Note:</strong> This data is generated by Deepseek V3 AI model</p>`;
                                        content.dataset.loaded = "true";
                                        return;
                                    }
                                    const chunk = decoder.decode(value, { stream: true });
                                    accumulatedText += chunk;
                                    const newLines = accumulatedText.split("\n");
                                    accumulatedText = newLines.pop();
                                    lines = lines.concat(newLines.filter(line => line.trim() !== ""));
                                    content.innerHTML = `<span class='close-btn' onclick='closePopup(this)'>×</span><p>${lines.map(l => l.replace(/^\d+\.\s*/, "")).join("<br>")}</p>`;
                                    readStream();
                                }).catch(error => {
                                    console.error("Streaming error:", error);
                                    content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>Error generating data. Please try again.</p>";
                                    content.dataset.loaded = "true";
                                });
                            }
                            readStream();
                        }).catch(error => {
                            console.error("Stream fetch error:", error);
                            content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>Error fetching data. Please try again.</p>";
                        });
                    } else {
                        content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>Loading...</p>";
                        fetch(url, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ sheet_name: sheetName, query: query })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error || data.data.length === 0) {
                                content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>N/A</p>";
                            } else if (sheetName === "Classification") {
                                content.innerHTML = '<span class="close-btn" onclick="closePopup(this)">×</span>' + data.data.map(row => {
                                    const columnsWithData = Object.entries(row)
                                        .filter(([key, value]) => key !== "Disease" && key.toLowerCase() !== "unnamed: 0" && !key.toLowerCase().includes("unnamed") && value && value !== "No details available")
                                        .map(([key, _]) => key);
                                    return `<p><strong>Disease:</strong> ${row["Disease"]}</p><p><strong>Categories:</strong> ${columnsWithData.length ? columnsWithData.join(", ") : "N/A"}</p>`;
                                }).join("<hr>");
                            } else {
                                content.innerHTML = '<span class="close-btn" onclick="closePopup(this)">×</span>' + data.data.map(row => {
                                    return `<p>${Object.entries(row).map(([key, value]) => {
                                        if (!value || value === "No details available") return "";
                                        if (key === "NOTE") return `<strong>Note:</strong> ${value}`;
                                        if (key.startsWith("Unnamed")) return value; // Already formatted with "Click Link"
                                        return `<strong>${key}:</strong> ${value}`;
                                    }).join("<br>")}</p>`;
                                }).join("<hr>").replace(/(<br>\s*)+/g, "<br>");
                            }
                            content.dataset.loaded = "true";
                        }).catch(error => {
                            console.error("Fetch error:", error);
                            content.innerHTML = "<span class='close-btn' onclick='closePopup(this)'>×</span><p>Error fetching data. Please try again.</p>";
                            content.dataset.loaded = "true";
                        });
                    }
                }
            }
        }

        function closePopup(el) {
            el.parentElement.classList.remove("active");
        }

        particlesJS.load('particles-js', '/static/particles.json', function() {
            console.log('particles.js loaded');
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            color: #222;
            border-top: 5px solid darkred;
            border-bottom: 5px solid darkred;
            overflow-y: auto;
            margin: 0;
        }
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: -1;
        }
        .header {
            background-color: darkred;
            color: white;
            padding: 15px 25px;
            font-size: 1.5em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar-title {
            display: flex; /* Use flex to align logo and text */
            align-items: center; /* Vertically center logo and text */
            gap: 10px; /* Space between logo and text */
        }
        .navbar-title a {
            color: white;
            text-decoration: none;
            font-size: 1.5em; /* Keep text size */
        }
        .navbar-logo {
            height: 40px; /* Make logo slightly larger than text */
            width: auto; /* Maintain aspect ratio */
        }
        .download-btn {
            padding: 8px 16px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .download-btn:hover {
            background-color: #000;
        }
        .main-container {
            display: flex;
            padding: 20px;
            gap: 20px;
            min-height: calc(100vh - 120px - 150px);
        }
        .button-panel {
            width: 30%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px;
            margin-left: 2%;
        }
        .block-button {
            background-color: darkred;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .block-button:hover {
            background-color: #a00000;
        }
        .image-panel {
            position: relative;
            width: 68%;
            margin-right: 2%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .image-panel img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            object-fit: cover;
        }
        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 300px;
            max-width: 90%;
            background-color: rgba(255, 255, 255, 0.98);
            border: 2px solid darkred;
            border-radius: 10px;
            padding: 20px;
            display: none;
            z-index: 10;
            overflow-y: auto;
            max-height: 80vh;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .popup-content.active {
            display: block;
            opacity: 1;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: darkred;
            font-weight: bold;
        }
        .footer {
            width: 100%;
            background-color: darkred;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
            box-sizing: border-box;
        }
        .footer-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }
        .footer-left img {
            height: 80px;
            width: auto;
        }
        .footer-left .footer-text {
            text-align: center;
        }
        .footer-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
            min-width: 200px;
        }
        .footer-right .social-icons {
            display: flex;
            gap: 8px;
        }
        .footer-right .social-icons a {
            color: white;
            font-size: 1.2em;
            text-decoration: none;
        }
        .footer-right .social-icons a:hover {
            color: #ddd;
        }
        .footer-right .contact-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .footer-right .contact-links a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .footer-right .contact-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="header">
        <div class="navbar-title">
            <img src="/static/logo.png" alt="OrphanAtlas Logo" class="navbar-logo">
            <a href="/">OrphanAtlas</a>
        </div>
        <span>Results for "{{ query }}"</span>
        <button class="download-btn" onclick="window.location.href='/download/{{ query }}'">Download Report</button>
    </div>
    <div class="main-container">
        <div class="button-panel">
            {% for sheet in sheets %}
                <button class="block-button" onclick="fetchSheetData('{{ sheet }}', '{{ query }}', 'sheet-content-{{ loop.index }}')">
                    {{ "AI Insights" if sheet == "AI Generated Data" else sheet }}
                </button>
            {% endfor %}
        </div>
        <div class="image-panel">
            <img src="/static/female_lab_scientist.png" alt="Scientist Image">
            {% for sheet in sheets %}
                <div class="popup-content" id="sheet-content-{{ loop.index }}"></div>
            {% endfor %}
        </div>
    </div>
    <div class="footer">
        <div class="footer-left">
            <a href="https://www.yu.edu/katz" target="_blank">
                <img src="/static/b7dc4fdb-d3cd-4188-add9-2d5347eeac37.png" alt="Katz School Logo">
            </a>
            <div class="footer-text">
                <div>205 Lexington Avenue, New York, NY 10016</div>
            </div>
        </div>
        <div class="footer-right">
            <div class="social-icons">
                <a href="https://www.linkedin.com" target="_blank"><i class="fab fa-linkedin"></i></a>
                <a href="https://www.instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://www.youtube.com" target="_blank"><i class="fab fa-youtube"></i></a>
                <a href="https://www.facebook.com" target="_blank"><i class="fab fa-facebook"></i></a>
            </div>
            <div class="contact-links">
                <a href="tel:646-592-4753"><i class="fas fa-phone"></i> 646-592-4753</a>
                <a href="mailto:info@katzschool.org"><i class="fas fa-envelope"></i> Email us</a>
            </div>
        </div>
    </div>
</body>
</html>
